<?xml version = "1.0" encoding = "utf-8" ?>

<component name = "chatTask" extends = "Task" >

  <interface>
    <field id="chat" type = "String" />
    <field id="uid" type="Int"/>
    <field id="authtoken" type="String"/>
    <field id="cookies" type="roArray"/>
    <field id="stream" type="String"/>
  </interface>
  <script type="text/brightscript" uri="pkg:/components/modules/LBRY_HTTP.brs" />
  <script type="text/brightscript" uri="pkg:/components/modules/LBRY_Parsing.brs" />
  <script type="text/brightscript" uri="pkg:/components/modules/LBRY_Account.brs" />
  <script type = "text/brightscript" >

    <![CDATA[

    sub init()
      m.top.functionName = "getChat"
      ? "[chat] Init"
      if m.global.debug = true
        ? "[chat] Verbose (DEBUG) mode enabled."
      end if
    end sub

    'credit to TheEndless on the Roku Development Fourms
    Function GetRandomHexString(length As Integer) As String
      hexChars = "0123456789ABCDEF"
      hexString = ""
      For i = 1 to length
          hexString = hexString + hexChars.Mid(Rnd(16) - 1, 1)
      Next
      Return hexString
    End Function
    sub getChat()
      chatstring = ""
      streamClaim = GetOdyseeStreamClaimID(m.top.stream)
      total_items = 0
      total_pages = 0
      sleepint = 2000 '1s by default, adapt over time
      base_sleepint = 2000
      finalchat = ""
      m.top.chat = "Chat Initialized"
      while true
        sleep(sleepint)
        jsonq = FormatJson({jsonrpc:"2.0",id:1,method:"comment.List",params:{page:0,claim_id:streamClaim,page_size:20}})
        data = QueryLBRYComments(jsonq)
        chatarray = []
        if data["result"]["total_items"] > total_items
          sleepint = sleepint / 2 'poll twice as fast
          for each message in data["result"]["items"]
            chatarray.Unshift(message.channel_name+": "+message.comment)
          end for
          total_items = data["result"]["total_items"]
          m.top.chat = chatarray.Join(Chr(10))
        else if sleepint < base_sleepint
          sleepint = sleepint * 2 'poll as slow as before
          chatarray = Invalid
          chatarray = []
        else if sleepint > base_sleepint
          sleepint = base_sleepint
          chatarray = Invalid
          chatarray = []
        end if
      end while
    end sub

    ]]>

  </script>

</component>
